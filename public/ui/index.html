<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>STRM Server - Vue UI</title>
    <style>
        html {
            overflow: hidden;
        }
      body {
        font-family: system-ui, 'Segoe UI', Roboto, 'Microsoft Yahei', sans-serif;
        margin: 0; /* remove default page margin to avoid extra vertical scroll */
        background: #fafafa;
        color: #222;
      }
      header {
        font-size: 1.4rem;
        margin-bottom: 1rem;
      }
      .card {
        background: #fff;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(22,27,35,0.06);
        margin-bottom: 1.25rem;
      }
      pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 6px;
        white-space: pre-wrap;
        word-break: break-word;
      }
      button { margin-right: 8px }

      .card-head{display:flex;align-items:center;justify-content:space-between}
      .actions{display:flex;gap:8px}
      .muted{color:#666;margin-top:0.25rem;margin-bottom:0.75rem}

      .btn{border:1px solid #dcdcdc;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
      .btn.primary{background:#0b76ef;color:#fff;border-color:transparent}
      .btn:hover{box-shadow:0 2px 6px rgba(11,118,239,0.08)}

  /* fixed height for directory browser to keep layout stable */
  .tree-wrap{height:480px;overflow:auto;padding-right:8px}
      .tree-root{list-style:none;padding-left:0;margin:0}

  .node-row{padding:4px 0}
  .node-head{display:flex;align-items:center;gap:8px;cursor:pointer;border-radius:6px;padding:4px}
  .node-head .name{font-size:0.98rem}
  .node-head .dir{color:#0b76ef}
  .node-head .file{color:#333}
  .node-head:hover{background:rgba(11,118,239,0.06)}
  .node-head:hover .dir{color:#084e9a}
  .node-head:hover .file{color:#084e9a}
  .node-children{margin-left:18px;margin-top:6px}
  .empty{color:#888;font-size:0.9rem}
  .child-list{list-style:none;padding-left:0;margin:0}
      :root{
        --bg:#fafafa; --card:#fff; --accent:#0b76ef; --muted:#666; --radius:10px; --shadow:0 6px 18px rgba(22,27,35,0.06)
      }
      html,body{height:100%;margin:0}
      body{
        font-family: system-ui, 'Segoe UI', Roboto, 'Microsoft Yahei', sans-serif;
        background:var(--bg);color:#222;
      }
      header.app-header{height:64px;display:flex;align-items:center;padding:0 20px;background:linear-gradient(90deg,#fff,#fbfdff);box-shadow:0 1px 0 rgba(0,0,0,0.04)}
      header.app-header h1{font-size:1.1rem;margin:0}

      .app-shell{display:flex;height:calc(100vh - 64px)}
      .sidebar{width:220px;background:#fff;border-right:1px solid #eee;padding:18px;box-sizing:border-box}
      .sidebar .logo{font-weight:600;margin-bottom:12px}
      .nav{display:flex;flex-direction:column;gap:8px}
      .nav button{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;border:1px solid transparent;background:transparent;text-align:left;cursor:pointer}
      .nav button.active{background:linear-gradient(90deg, rgba(11,118,239,0.06), transparent);border-color:#e6f3ff}
      .nav .small{font-size:0.85rem;color:var(--muted)}

      .main{flex:1;padding:18px;overflow:auto}
      .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:14px}
      .card-head{display:flex;align-items:center;justify-content:space-between}
      .muted{color:var(--muted);margin-top:6px}

      /* tree/browser styles */
      .tree-wrap{height:520px;overflow:auto;padding-right:8px}
      .tree-root{list-style:none;padding-left:0;margin:0}
      .node-row{padding:4px 0}
      .node-head{display:flex;align-items:center;gap:8px;cursor:pointer;border-radius:6px;padding:4px}
      .node-head .name{font-size:0.98rem}
      .node-head .dir{color:var(--accent)}
      .node-head .file{color:#333}
      .node-head:hover{background:rgba(11,118,239,0.04)}
      .node-children{margin-left:18px;margin-top:6px}
      .empty{color:#888;font-size:0.9rem}

      /* session and file list */
      .session-card{background:#f9fbff;border:1px solid #e6f0ff;padding:12px;border-radius:8px;margin-top:8px}
      .file-list{max-height:220px;overflow:auto;margin-top:10px;padding-left:0}
      .file-item{display:flex;align-items:center;justify-content:space-between;padding:6px;border-bottom:1px dashed rgba(0,0,0,0.04)}

      pre{background:#f5f5f5;padding:12px;border-radius:6px;white-space:pre-wrap}
      .btn{border:1px solid #dcdcdc;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
      .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
      .small-btn{font-size:0.85rem;padding:4px 8px;border-radius:6px;border:1px solid #dcdcdc;background:#fff;cursor:pointer}
    </style>
    <div id="app">
      <header class="app-header" style="display:flex;align-items:center;justify-content:space-between">
        <h1>STRM Server</h1>
        <div class="header-right">
          <div v-if="auth.authenticated" style="display:flex;align-items:center;gap:10px">
            <div class="small">å·²ç™»å½•: <strong>{{ auth.username }}</strong></div>
            <button class="btn" @click="logout">ç™»å‡º</button>
          </div>
          <div v-else>
            <button class="btn" @click="activeView='settings'">ç™»å½•</button>
          </div>
        </div>
      </header>
      <div class="app-shell">
        <aside class="sidebar">
          <div class="logo">STRM æ§åˆ¶å°</div>
          <div class="nav">
            <button :class="{active: activeView==='dashboard'}" @click="activeView='dashboard'">æ¦‚è§ˆ</button>
            <button :class="{active: activeView==='browser'}" @click="activeView='browser'">ç›®å½•æµè§ˆ</button>
            <button :class="{active: activeView==='scanner'}" @click="activeView='scanner'">æ‰«æå™¨</button>
            <button :class="{active: activeView==='logs'}" @click="activeView='logs'">æœåŠ¡æ—¥å¿—</button>
            <button :class="{active: activeView==='settings'}" @click="activeView='settings'">è®¾ç½®</button>
          </div>
        </aside>

        <main class="main">
          <section v-if="activeView==='dashboard'" class="card">
            <div class="card-head"><h3>æ¦‚è§ˆ</h3></div>
            <div class="muted">æœ€è¿‘æ‰«æä¸ç³»ç»ŸçŠ¶æ€</div>
            <div style="display:flex;gap:12px;margin-top:12px">
              <div class="card" style="flex:1">
                <div>æ‰«æçŠ¶æ€</div>
                <div style="margin-top:6px">è¿è¡Œä¸­: <strong>{{ scanStatus.running ? 'æ˜¯' : 'å¦' }}</strong></div>
                <div style="margin-top:6px">å·²è®¿é—®: <strong>{{ scanStatus.totalVisited }}</strong></div>
                <div style="margin-top:6px">æ–‡ä»¶: <strong>{{ scanStatus.filesFound }}</strong></div>
              </div>
              <div class="card" style="flex:1">
                <div>æ—¥å¿—</div>
                <div style="margin-top:8px"><button class="btn" @click="openLogs">æŸ¥çœ‹æœ€è¿‘æ—¥å¿—</button></div>
              </div>
            </div>
          </section>

          <section v-if="activeView==='browser'" class="card">
            <div class="card-head"><h3>Alist ç›®å½•æµè§ˆ</h3><div><button class="btn" @click="loadRoot">åˆ·æ–°</button></div></div>
            <p class="muted">åŠ è½½ alist ç›®å½•ç»“æ„</p>
            <div class="tree-wrap">
              <template v-if="error"> <div class="error">{{ error }}</div> </template>
              <template v-else>
                <ul class="tree-root">
                  <li v-for="item in nodes[rootPath] || []" :key="rootPath + '/' + item.name">
                    <node-item :item="item" :parent-path="rootPath" :nodes="nodes" @load-children="load"></node-item>
                  </li>
                </ul>
              </template>
            </div>
          </section>

          <section v-if="activeView==='scanner'" class="card">
            <div class="card-head"><h3>æ‰«æå™¨</h3><div><button class="btn primary" @click="rescan" :disabled="scanning || scanStatus.running">é‡æ–°æ‰«æ</button></div></div>
            <p class="muted">æ‰«æå…¨éƒ¨ï¼Œå¹¶ç”Ÿæˆ .strm æ–‡ä»¶</p>
            <div style="margin-top:12px">
              <div v-if="scanStatus.running">å½“å‰æ­£åœ¨æ‰«æ: {{ scanStatus.currentPath }} ï¼ˆå·²è®¿é—® {{ scanStatus.totalVisited }}ï¼‰</div>
              <div v-else>
                <div>æœ€è¿‘ç»“æœï¼š{{ scannerResult || 'æ— ' }}</div>
                <div style="margin-top:8px">
                  <button class="btn" @click="viewLatest">æŸ¥çœ‹ä¸Šæ¬¡æ‰«æè¯¦æƒ…</button>
                  <button class="btn" @click="downloadHistory">ä¸‹è½½å†å²</button>
                </div>
              </div>

              <div v-if="latestSession" class="session-card" style="margin-top:12px">
                <div><strong>ä¼šè¯ï¼š</strong>{{ latestSession.id }} â€¢ å¼€å§‹: {{ latestSession.startedAt ? new Date(latestSession.startedAt).toLocaleString() : '-' }}</div>
                <div style="margin-top:8px">ç»Ÿè®¡: {{ latestSession.totalVisited }} visited â€¢ {{ latestSession.filesFound }} files â€¢ {{ latestSession.strmCreated || 0 }} .strm</div>
                <div v-if="latestSession.createdFiles && latestSession.createdFiles.length" class="file-list">
                  <div v-for="(f, idx) in latestSession.createdFiles" :key="idx" class="file-item">
                    <div class="path">{{ f }}</div>
                    <div><button class="small-btn" @click="copyPath(f)">å¤åˆ¶è·¯å¾„</button></div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section v-if="activeView==='logs'" class="card">
            <div class="card-head"><h3>æœåŠ¡æ—¥å¿—</h3><div><button class="btn" @click="fetchLogs">åˆ·æ–°</button><button class="btn" @click="downloadLogs">ä¸‹è½½</button></div></div>
            <p class="muted">æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—ï¼ˆé»˜è®¤ 200 è¡Œï¼‰</p>
            <div style="margin-top:12px"><pre v-if="logsContent" style="max-height:480px;overflow:auto;white-space:pre-wrap">{{ logsContent }}</pre><div v-else class="empty">å°šæœªåŠ è½½æ—¥å¿—</div></div>
          </section>

          <section v-if="activeView==='settings'" class="card">
            <h3>è®¾ç½® / ç”¨æˆ·</h3>
            <p class="muted">ç®¡ç†è®¿é—®æ§åˆ¶</p>
            <div>
              <div v-if="!auth.authenticated">
                <div style="display:flex;gap:8px;align-items:center">
                  <input placeholder="ç”¨æˆ·å" v-model="authForm.username" />
                  <input placeholder="å¯†ç " v-model="authForm.password" type="password" />
                  <button class="btn primary" @click="login">ç™»å½•</button>
                </div>
                <div v-if="authError" style="color:#b00;margin-top:8px">{{ authError }}</div>
              </div>
              <div v-else>
                <div>å·²ç™»å½•ä¸º <strong>{{ auth.username }}</strong></div>
                <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                  <input placeholder="å½“å‰å¯†ç " v-model="pwdForm.oldPassword" type="password" />
                  <input placeholder="æ–°å¯†ç " v-model="pwdForm.newPassword" type="password" />
                  <button class="btn primary" @click="changePassword">ä¿®æ”¹å¯†ç </button>
                </div>
                <div v-if="pwdMsg" style="margin-top:8px;color:#666">{{ pwdMsg }}</div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
      const { createApp, ref, reactive } = Vue;

      // recursive component template
      const NodeItem = {
        name: 'node-item',
        props: ['item', 'parentPath', 'nodes'],
        setup(props, { emit }) {
          const expanded = ref(false);

          function fullPath() {
            if (props.parentPath === '/' || props.parentPath === '') return `/${props.item.name}`.replace('//','/');
            return `${props.parentPath}/${props.item.name}`.replace('//','/');
          }

          function toggle() {
            if (props.item.is_dir) {
              const p = fullPath();
              if (!props.nodes[p]) {
                // Ask parent to load
                emit('load-children', p);
              }
              expanded.value = !expanded.value;
            }
          }

          return { expanded, fullPath, toggle };
        },
        template: `
          <div class="node-row">
            <div class="node-head" @click="toggle">
              <span v-if="item.is_dir" class="dir">
                <strong v-text="expanded ? 'â–¾ ' : 'â–¸ '"></strong>
                <span class="name" v-text="item.name || '/'"></span>
              </span>
              <span v-else class="file">ğŸ“„ <span class="name" v-text="item.name"></span></span>
            </div>

            <div v-if="expanded" class="node-children">
              <template v-if="nodes[fullPath()] && nodes[fullPath()].length===0">
                <div class="empty">(ç©º)</div>
              </template>
              <ul class="child-list">
                <li v-for="child in nodes[fullPath()] || []" :key="fullPath() + '/' + child.name">
                  <node-item :item="child" :parent-path="fullPath()" :nodes="nodes" @load-children="$emit('load-children', $event)"></node-item>
                </li>
              </ul>
            </div>
          </div>
        `
      };

      createApp({
        components: { 'node-item': NodeItem },
        setup() {
          const rootPath = ref('/');
          const nodes = reactive({});
          const error = ref('');
          const activeView = ref('dashboard');
          const auth = reactive({ authenticated: false, username: '' });
          const authForm = reactive({ username: '', password: '' });
          const authError = ref('');
          const showLogin = ref(false);
          const showSettings = ref(false);
          const pwdForm = reactive({ oldPassword: '', newPassword: '' });
          const pwdMsg = ref('');
          const scannerResult = ref('');
          const scanning = ref(false);
          const scanStatus = reactive({
            running: false,
            totalVisited: 0,
            filesFound: 0,
            currentPath: '',
            elapsedMs: 0,
            error: ''
          });

          let statusTimer = null;
          const latestSession = ref(null);
          const logsContent = ref('');
          
          function closeLatest() {
            latestSession.value = null;
          }

          async function copySessionJson() {
            try {
              const text = JSON.stringify(latestSession.value, null, 2);
              await navigator.clipboard.writeText(text);
              alert('å·²å¤åˆ¶ä¼šè¯ JSON åˆ°å‰ªè´´æ¿');
            } catch (e) {
              alert('å¤åˆ¶å¤±è´¥: ' + e);
            }
          }

          async function copyPath(p) {
            try {
              await navigator.clipboard.writeText(p);
              // small visual feedback
              // (could be improved to toast)
            } catch (e) {
              alert('å¤åˆ¶å¤±è´¥: ' + e);
            }
          }

          async function checkAuth() {
            try {
              const res = await fetch('/auth/me');
              if (!res.ok) return false;
              const data = await res.json();
              auth.authenticated = !!data.authenticated;
              auth.username = data.username || '';
              return auth.authenticated;
            } catch (e) {
              auth.authenticated = false;
              auth.username = '';
              return false;
            }
          }

          async function login() {
            authError.value = '';
            try {
              const res = await fetch('/auth/login', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: authForm.username, password: authForm.password })
              });
              if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || `${res.status}`);
              }
              await checkAuth();
              showLogin.value = false;
              authForm.password = '';
            } catch (e) {
              authError.value = 'ç™»å½•å¤±è´¥: ' + (e.message || e);
            }
          }

          async function logout() {
            try {
              await fetch('/auth/logout', { method: 'POST' });
            } catch (e) {
              // ignore
            }
            // After logout, go to the login page so the server can serve the correct page
            // (also clears client-side auth state)
            await checkAuth();
            window.location.href = '/ui/login.html';
          }

          async function changePassword() {
            pwdMsg.value = '';
            try {
              const res = await fetch('/auth/change-password', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ oldPassword: pwdForm.oldPassword, newPassword: pwdForm.newPassword })
              });
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              pwdMsg.value = 'å¯†ç ä¿®æ”¹æˆåŠŸ';
              pwdForm.oldPassword = '';
              pwdForm.newPassword = '';
            } catch (e) {
              pwdMsg.value = 'ä¿®æ”¹å¤±è´¥: ' + (e.message || e);
            }
          }

          async function fetchStatus() {
            try {
              const res = await fetch('/scanner/status');
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const data = await res.json();
              scanStatus.running = data.running;
              scanStatus.totalVisited = data.totalVisited;
              scanStatus.filesFound = data.filesFound;
              scanStatus.strmCreated = data.strmCreated || 0;
              scanStatus.currentPath = data.currentPath;
              scanStatus.elapsedMs = data.elapsedMs || 0;
              scanStatus.error = data.error || '';
              // if scanning finished, stop polling
              if (!data.running) {
                stopStatusPoll();
              }
              return data;
            } catch (e) {
              // ignore transient errors
              return null;
            }
          }

          async function startStatusPoll() {
            if (statusTimer) return;
            // fetch once to see if a scan is running; only start interval if running
            const data = await fetchStatus();
            if (data && data.running) {
              statusTimer = setInterval(fetchStatus, 1000);
            }
          }

          function stopStatusPoll() {
            if (statusTimer) {
              clearInterval(statusTimer);
              statusTimer = null;
            }
          }

          async function load(p) {
            error.value = '';
            try {
              const res = await fetch(`/api/fs/list?path=${encodeURIComponent(p)}`);
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const data = await res.json();
              // alist returns data.content as array
              nodes[p] = data.content || [];
            } catch (e) {
              error.value = 'åŠ è½½å¤±è´¥: ' + e;
              nodes[p] = [];
            }
          }

          async function loadRoot() {
            nodes[rootPath.value] = [];
            await load(rootPath.value);
          }

          async function rescan() {
            scannerResult.value = 'è§¦å‘ä¸­...';
            scanning.value = true;
            try {
              const res = await fetch('/scanner/rescan');
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const text = await res.text();
              scannerResult.value = text;
              // start polling status
              startStatusPoll();
            } catch (e) {
              scannerResult.value = 'è¯·æ±‚å¤±è´¥: ' + e;
            } finally {
              scanning.value = false;
            }
          }

          async function viewLatest() {
            try {
              const res = await fetch('/scanner/history/latest');
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const data = await res.json();
              latestSession.value = data;
            } catch (e) {
              latestSession.value = { error: String(e) };
            }
          }

          async function fetchLogs() {
            try {
              const res = await fetch('/api/logs?lines=300');
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const data = await res.json();
              if (data.ok) {
                logsContent.value = data.content;
              } else {
                logsContent.value = 'è¯»å–æ—¥å¿—å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
              }
            } catch (e) {
              logsContent.value = 'è¯·æ±‚å¤±è´¥: ' + e;
            }
          }

          async function openLogs() {
            // switch to logs view first (so the area is visible) then fetch
            activeView.value = 'logs';
            await fetchLogs();
          }

          async function downloadLogs() {
            try {
              const res = await fetch('/api/logs/download');
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const data = await res.json();
              if (data.ok) {
                const blob = new Blob([data.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `alistrm-log-${Date.now()}.log`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
              } else {
                alert('ä¸‹è½½å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
              }
            } catch (e) {
              alert('è¯·æ±‚å¤±è´¥: ' + e);
            }
          }

          async function downloadHistory() {
            try {
              const res = await fetch('/scanner/history');
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const data = await res.json();
              const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `scan-history-${Date.now()}.json`;
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
            } catch (e) {
              alert('ä¸‹è½½å¤±è´¥: ' + e);
            }
          }

          function formatElapsed(ms) {
            if (!ms || ms <= 0) return '0s';
            const s = Math.floor(ms / 1000);
            if (s < 60) return `${s}s`;
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m}m ${sec}s`;
          }

          // require authentication to access this page: redirect to separate login page if not authenticated
          (async () => {
            const ok = await checkAuth();
            if (!ok) {
              // redirect to login page served under /ui
              window.location.href = '/ui/login.html';
              return;
            }
            // load default root on mount
            await loadRoot();
            // start polling status so UI reflects any running scan
            startStatusPoll();
          })();

          // expose logs content and auth helpers
          return { rootPath, nodes, load, loadRoot, error, rescan, scannerResult, scanning, scanStatus, formatElapsed, latestSession, viewLatest, downloadHistory, closeLatest, copySessionJson, copyPath, logsContent, fetchLogs, downloadLogs, openLogs,
            auth, authForm, authError, showLogin, showSettings, pwdForm, pwdMsg, login, logout, changePassword, checkAuth, activeView };
        }
      }).mount('#app');
    </script>
  </body>
</html>